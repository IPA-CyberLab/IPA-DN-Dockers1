# イメージ名
dockervault_mssqlserver_2019_with_ubuntu_2004

# バージョン
20220724_001

# イメージの目的
これは、Ubuntu 20.04 環境上の Microsoft SQL Server 2019 Express の安定動作イメージである。





# ビルド方法 (dn-docker1 にて)

## 初回のみ Git クローンする
cd ~/ && git clone --recursive https://github.com/IPA-CyberLab/IPA-DN-Dockers1.git

## ビルド実施
cd ~/IPA-DN-Dockers1/dockervault_mssqlserver_2019_with_ubuntu_2004/ && (cd $(git rev-parse --show-toplevel) && git pull origin master && git submodule update --init --recursive) && docker build -t tmpimg01 . && echo Docker Image Build OK.

# ビルドしたマシンにおける簡易動作テスト (必要な場合のみ)
rm -fr /var/opt/mssql/ && mkdir -p /var/opt/mssql/

docker run -it --rm --network host --mount type=bind,source=/var/opt/mssql/,target=/var/opt/mssql/ --env MSSQL_SA_PASSWORD=SqlNeko123 tmpimg01 /opt/mssql/bin/sqlservr --pid Express --reset-sa-password --accept-eula

## 無事起動したら Ctrl + C で終了


# イメージ公開
docker login dockervault-auth.dn.ipantt.net

docker tag tmpimg01 dockervault-auth.dn.ipantt.net/dockervault_mssqlserver_2019_with_ubuntu_2004:20220724_001

docker push dockervault-auth.dn.ipantt.net/dockervault_mssqlserver_2019_with_ubuntu_2004:20220724_001





# 実行方法 (dn-docker2 でテスト)

# イメージ取得

# rm -fr /var/opt/mssql/
mkdir -p /var/opt/mssql/

docker pull dockervault.dn.ipantt.net/dockervault_mssqlserver_2019_with_ubuntu_2004:20220724_001

# 初回起動 (EULA に同意して SQL Server 2019 の sa パスワードを初期設定)
docker run -it --rm --network host --mount type=bind,source=/var/opt/mssql/,target=/var/opt/mssql/ --env MSSQL_SA_PASSWORD=SqlNeko123 dockervault.dn.ipantt.net/dockervault_mssqlserver_2019_with_ubuntu_2004:20220724_001 /opt/mssql/bin/sqlservr --pid Express --reset-sa-password --accept-eula

# 無事起動したら Ctrl + C で一度終了

# デーモンとして OS の起動時に常時起動するように登録して実際に動作を開始
docker run -d --restart always --name daemon_mssqlserver --log-driver=journald --log-opt tag=docker_log/{{.Name}}/{{.ID}} --network host --mount type=bind,source=/var/opt/mssql/,target=/var/opt/mssql/ dockervault.dn.ipantt.net/dockervault_mssqlserver_2019_with_ubuntu_2004:20220724_001

# デーモンとして動作しているコンテナのログの確認 (必要に応じて)
docker logs -f daemon_mssqlserver

# デーモンとして動作しているコンテナへの bash への入り方 (デバッグ用)
docker exec -it daemon_mssqlserver bash

# デーモンとして動作しているコンテナへの sqlcmd の入り方 (デバッグ用)
docker exec -it daemon_mssqlserver bash


# フォアグラウンドプロセスとしてデバッグ起動
docker run -it --rm --network host --mount type=bind,source=/var/opt/mssql/,target=/var/opt/mssql/ dockervault.dn.ipantt.net/dockervault_mssqlserver_2019_with_ubuntu_2004:20220724_001



# 停止
docker stop daemon_mssqlserver

# 再開
docker start daemon_mssqlserver

# 動作中のコンテナ削除
docker stop daemon_mssqlserver
docker rm daemon_mssqlserver

rm -fr /var/opt/mssql/







sudo apt-get -y update && sudo apt-get -y install docker.io


